version: 2.1


orbs:
  buildevents: honeycombio/buildevents@dev:ben.add_polling


executors:
  linuxgo:
    docker:
      - image: circleci/golang:1.10

jobs:
  setup:
    executor: linuxgo
    steps:
      - buildevents/start_trace
  catchend:
    executor: linuxgo
    steps:
      - buildevents/watch_build_and_finish
  sleep2:
    executor: linuxgo
    steps:
      - buildevents/with_job_span:
          steps:
            - run: buildevents cmd $CIRCLE_WORKFLOW_ID \
                    ${BUILDEVENTS_SPAN_ID} sleep -- sleep 20

  sleep3:
    executor: linuxgo
    steps:
      - buildevents/with_job_span:
          steps:
            - run: date +%s > /tmp/start
            - run: sleep 15
            # - run: "false"
  finish:
    executor: linuxgo
    steps:
      - run: echo "all done"
workflows:
  paint:
    jobs:
      - setup
      - catchend:
          requires:
            - setup
      - sleep2:
          requires:
            - setup
      - sleep3:
          requires:
            - setup
      - finish:
          requires:
            - sleep2
            - sleep3

